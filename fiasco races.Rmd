---
title: "Fiasco Races Round 1 - Data Analysis"
author: "Greg Sward"
date: "2022-10-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data_cruncing, echo=FALSE, message=FALSE}
library(caret)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(lubridate)
library(party)
library(purrr)
library(randomForest)
library(rvest)
library(stringr)
library(tree)


getTimesInSeconds <- function(x){
  if(str_count(x, pattern = ":") == 1){
    return(lubridate::period_to_seconds(lubridate::ms(x)))
  }else{
    return(lubridate::period_to_seconds(lubridate::hms(x)))
  }
}


#define a function to help convert the HTML data to a useful dataframe
dataCleansing <- function(x, race_number = 0,  nrow_to_remove = 0){
  #get rid of the last 2 columns
  x <- x[,1:(ncol(x)-2)]
  
  #fix column names
  colnames(x) <- c("Cat", "Position", "Rider", "Time", "Avg_WKG", "Avg_W", "Normalized_W", "WKG_20m", "WKG_5m", "WKG_1m", "WKG_30s", "WKG_15s", "Weight", "Age", "Avg_Hr", "Max_Hr", "Height")
  
  #icons for the first 3 positions. need to fix.  A bunch of other changes, easier to do outside dplyr
  x$Position <- 1:nrow(x)
  x$Avg_WKG <- as.numeric(gsub(x = x$Avg_WKG, pattern = "w/kg", replacement = ""))
  x$Avg_W <- as.numeric(gsub(x = x$Avg_W, pattern = "w", replacement = ""))
  x$Normalized_W <- as.numeric(gsub(x = x$Normalized_W, pattern = "w", replacement = ""))
  x$WKG_20m<- as.numeric(gsub(x = x$WKG_20m, pattern = "w/kg", replacement = ""))
  x$WKG_5m<- as.numeric(gsub(x = x$WKG_5m, pattern = "w/kg", replacement = ""))
  x$WKG_1m<- as.numeric(gsub(x = x$WKG_1m, pattern = "w/kg", replacement = ""))
  x$WKG_30s<- as.numeric(gsub(x = x$WKG_30s, pattern = "w/kg", replacement = ""))
  x$WKG_15s<- as.numeric(gsub(x = x$WKG_15s, pattern = "w/kg", replacement = ""))
  x$Weight <- as.numeric(gsub(x = x$Weight, pattern = "kg", replacement = ""))
  x$Age <- as.factor(x$Age)
  x$Avg_Hr <- as.numeric(gsub(x = x$Avg_Hr, pattern = "bpm", replacement = ""))
  x$Max_Hr <- as.numeric(gsub(x = x$Max_Hr, pattern = "bpm", replacement = ""))
  x$Height <- as.numeric(gsub(x = x$Height, pattern = "cm", replacement = ""))
  
  time_chr <- map_chr(strsplit(x$Time, "\\+"), 1)
  x$Time <- map_dbl(time_chr, getTimesInSeconds)
  x$Rel_Time <- x$Time/x$Time[1]
  rm(time_chr)
  
  x <- x[1:(nrow(x)-nrow_to_remove),]
  
  #now dplyr
  x <- x %>%
    mutate(
      Round = 1,
      Race_Number = race_number,
      Top_20 = as.factor(ifelse(Position <= 20, "Yes", "No")),
      Normalized_WKG = round(Normalized_W / Weight, 2)
    ) %>%
    select(
      Round,
      Race_Number,
      Cat,
      Rider,
      Position,
      Top_20,
      Time,
      Rel_Time,
      Weight,
      Height,
      Age,
      Avg_Hr,
      Max_Hr,
      Avg_WKG,
      Avg_W,
      Normalized_WKG,
      Normalized_W,
      everything()
    ) %>%
    mutate(
      W_20m = WKG_20m * Weight,
      W_5m = WKG_5m * Weight,
      W_1m = WKG_1m * Weight,
      W_30S = WKG_30s * Weight,
      W_15s = WKG_15s * Weight
    )
  
  return(x)
}

data_files <- list(
  "ZRL_Race_1.html",
  "ZRL_Race_2.html",
  # "ZRL_Race_3.html",
  "ZRL_Race_4.html",
  "ZRL_Race_5.html")

getRaceHTMLData <- function(x){
  read_html(paste0("data/", x)) %>%
    html_element("table") %>%
    html_table()
}

race_html_data <- lapply(data_files, getRaceHTMLData)

race_data <- lapply(race_html_data, dataCleansing)
race_data <- purrr::map2_dfr(.x = race_html_data, .y = c(1,2,4,5), .f = dataCleansing) %>%
  mutate(Rider_ID = as.numeric(as.factor(Rider)))

```


## Data and Background

This document summarizes various data-related observations from Round 1 of Americas East Open Division 1 - C category.  The dataset includes all races except Race 3 - the team time trial race.  All data was collected from Zwift Power.


## Rider Results
The below graph shows the finishing positions of different riders (the rider IDs have been anonymized).  It's interesting that almost none of the riders placed consistently in the top 10, or even top 20. The ones that tended to only ride a couple races.  Many riders had a very wide range of results.  It does not appear to be uncommon for a rider to get in the top 5 in one race and 50th+ in another. 

```{r rider_results, echo=FALSE, message=FALSE, fig.dim = c(12, 16)}

p <- ggdotchart(
  data = race_data %>% mutate(Race_Number = as.factor(Race_Number)),
  x = "Rider_ID",
  xlab = "Rider_ID",
  y = "Position",
  color = "Race_Number",
  #palette = c("#00AFBB", "#FC4E07"),
  sorting = "ascending",
  rotate = TRUE,                              
  dot.size = 2,
  title = "Rider ID vs Finishing Position",
  ggtheme = theme_pubr()                        
) +
  theme_cleveland()
  
plotly::ggplotly(p)

```


## Rider Participation
Below is the distribution of number races competed in by rider.  No rider competed in all 5 of 5 races.

``` {r group_results, echo=FALSE, message=FALSE}
d <- race_data %>%
  dplyr::select(Rider_ID) %>%
  dplyr::group_by(Rider_ID) %>%
  dplyr::summarize(Race_Count = n())

p <- ggplot(data = d, aes(x = Race_Count)) +
  geom_bar(fill = "orange") +
  theme_pubclean()

rm(d)
  
plotly::ggplotly(p)
```
